<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluid Particle System with Sound</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: black;
        }
        #startButton {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <button id="startButton">Start</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <script>
        let inc = 0.1;
        let scl = 10;
        let cols, rows;
        let zoff = 0;
        let particles = [];
        let flowfield;
        let maxSpeed = 2;
        let audioContext;
        let started = false;

        document.getElementById('startButton').addEventListener('click', () => {
            startSketch();
        });

        function startSketch() {
            document.getElementById('startButton').style.display = 'none';

            // Iniciar AudioContext manualmente
            audioContext = getAudioContext();
            audioContext.resume().then(() => {
                console.log('Audio context started');
            });

            new p5((p) => {
                p.setup = function() {
                    p.createCanvas(p.windowWidth, p.windowHeight);
                    cols = p.floor(p.width / scl);
                    rows = p.floor(p.height / scl);
                    flowfield = new Array(cols * rows);

                    for (let i = 0; i < 500; i++) {
                        particles[i] = new Particle(p);
                    }

                    p.background(0);
                };

                p.draw = function() {
                    let yoff = 0;
                    for (let y = 0; y < rows; y++) {
                        let xoff = 0;
                        for (let x = 0; x < cols; x++) {
                            let index = x + y * cols;
                            let angle = p.noise(xoff, yoff, zoff) * p.TWO_PI;
                            let v = p.createVector(p.cos(angle), p.sin(angle));
                            v.y += 1;
                            v.setMag(0.5);
                            flowfield[index] = v;
                            xoff += inc;
                        }
                        yoff += inc;
                    }

                    for (let i = 0; i < particles.length; i++) {
                        particles[i].follow(flowfield);
                        particles[i].update();
                        particles[i].edges();
                        particles[i].show();
                    }
                    zoff += 0.003;
                };

                class Particle {
                    constructor(p) {
                        this.p = p;
                        this.pos = p.createVector(p.random(p.width), p.random(p.height));
                        this.vel = p.createVector(0, 0);
                        this.acc = p.createVector(0, 0);
                        this.maxSpeed = maxSpeed;
                        this.prevPos = this.pos.copy();
                        this.playSound();
                    }

                    follow(vectors) {
                        let x = this.p.floor(this.pos.x / scl);
                        let y = this.p.floor(this.pos.y / scl);
                        let index = x + y * cols;
                        let force = vectors[index];
                        this.applyForce(force);
                    }

                    applyForce(force) {
                        this.acc.add(force);
                    }

                    update() {
                        this.vel.add(this.acc);
                        this.vel.limit(this.maxSpeed);
                        this.pos.add(this.vel);
                        this.acc.mult(0);
                    }

                    show() {
                        this.p.stroke(255, 100);
                        this.p.strokeWeight(1);
                        this.p.line(this.pos.x, this.pos.y, this.prevPos.x, this.prevPos.y);
                        this.prevPos = this.pos.copy();
                    }

                    edges() {
                        if (this.pos.x > this.p.width) this.pos.x = 0;
                        if (this.pos.x < 0) this.pos.x = this.p.width;
                        if (this.pos.y > this.p.height) this.pos.y = 0;
                        if (this.pos.y < 0) this.pos.y = this.p.height;
                        this.prevPos = this.pos.copy();
                    }

                    playSound() {
                        let freq = this.p.random(100, 1000);
                        let osc = new p5.Oscillator('sine');
                        osc.freq(freq);
                        osc.amp(0);
                        osc.start();

                        osc.amp(0.1, 2);
                        osc.amp(0, 2, 8);

                        osc.stop(10);
                    }
                }
            });
        }
    </script>
</body>
</html>
